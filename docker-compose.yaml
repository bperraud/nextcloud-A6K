version: '3.8'

x-common-env: &common-env
  ALLOW_EMPTY_PASSWORD: "no"
  MARIADB_GALERA_CLUSTER_NAME: nextcloud-cluster
  MARIADB_GALERA_CLUSTER_ADDRESS: gcomm://mariadb1,mariadb2,mariadb3
  MARIADB_EXTRA_FLAGS: >-
    --wsrep-sync-wait=3
    --transaction-isolation=READ-COMMITTED
    --sql-mode=NO_AUTO_VALUE_ON_ZERO,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION
    --expire-logs-days=3


services:
  mariadb1:
    image: bitnami/mariadb-galera:11.4.7
    restart: unless-stopped
    networks:
      - galera_net
    container_name: mariadb1
    env_file:
      - ./mariadb-galera/.env
    environment:
      <<: *common-env
      MARIADB_GALERA_CLUSTER_BOOTSTRAP: yes
      MARIADB_GALERA_NODE_NAME: mariadb1
    volumes:
      - mariadb1_data:/bitnami/mariadb
      - ./conf.d:/bitnami/mariadb/conf

  mariadb2:
    image: bitnami/mariadb-galera:11.4.7
    restart: unless-stopped
    networks:
      - galera_net
    container_name: mariadb2
    env_file:
      - ./mariadb-galera/.env
    environment:
      <<: *common-env
      MARIADB_GALERA_CLUSTER_BOOTSTRAP: no
      MARIADB_GALERA_NODE_NAME: mariadb2
    volumes:
      - mariadb2_data:/bitnami/mariadb
      - ./conf.d:/bitnami/mariadb/conf

  # mariadb3:
  #   image: bitnami/mariadb-galera:11.4.7
  #   restart: unless-stopped
  #   networks:
  #     - galera_net
  #   container_name: mariadb3
  #   environment:
  #     <<: *common-env
  #     MARIADB_GALERA_NODE_NAME: mariadb3
  #   volumes:
  #     - mariadb3_data:/bitnami/mariadb
  #     - ./conf.d:/bitnami/mariadb/conf


  proxysql:
    build:
      context: ./proxysql/
      dockerfile: Dockerfile
    container_name: proxysql
    env_file:
      - ./mariadb-galera/.env
    ports:
      - "6033:6033"  # MySQL client-facing port
      - "6032:6032"  # Admin port
    volumes:
      - ./proxysql/proxysql.cnf.template:/etc/proxysql.cnf.template:ro
    # healthcheck:
    #   test: [ "CMD", "bash", "/probe.sh", "readiness" ]
    #   interval: 15s
    #   timeout: 3s
    #   retries: 5
    #   start_period: 30s
    restart: always
    networks:
      - galera_net

  redis:
    image: redis:apline
    restart: always

volumes:
  mariadb1_data:
  mariadb2_data:
  mariadb3_data:
  redis:

networks:
  galera_net:
    driver: bridge
